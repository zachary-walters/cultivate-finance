version: '3'

name: cultivate-finance 

services:
  gateway:
    container_name: gateway
    build:
      context: ./../gateway
      dockerfile: ./../gateway/gateway.dockerfile
    restart: always
    ports: 
      - "8661:8661"
    deploy:
      mode: replicated
      replicas: 1
    environment:
      PORT: 8661
      NATS_URI: nats://nats:4222
    depends_on:
      - nats


  401k-calculator-api:
    container_name: rest-api-server
    build:
      context: ./../401k_calculator
      dockerfile: ./../401k_calculator/401k_calculator.dockerfile
    restart: always
    ports:
      - "8660:8660"
    deploy:
      mode: replicated
      replicas: 1
    environment:
      PORT: 8660
      NATS_URI: nats://nats:4222
    depends_on:
      - nats

  webapp:
    container_name: webapp
    build: 
      context: ./../webapp
      dockerfile: ./../webapp/webapp.dockerfile
    restart: always
    ports: 
      - "8662:8662"
    deploy:
      mode: replicated
      replicas: 1  

  nats: 
    image: 'nats:latest'
    entrypoint: "nats-server -DV"
    expose:
      - "4222"
    ports: 
      - "8222:8222"
    hostname: nats-server

  # sonarqube: 
  #   container_name: sonarqube
  #   build:
  #     context: ./../sonarqube
  #     dockerfile: ./../sonarqube/sonarqube.dockerfile
  #   restart: always
  #   ports:
  #     - "9998:9092"
  #     - "9999:9000"
  #   deploy:
  #     mode: replicated
  #     replicas: 1

  # webapp_vue:
  #   container_name: webapp_vue
  #   build:
  #     context: ./../webapp_vue
  #     dockerfile: ./../webapp_vue/webapp_vue.dockerfile
  #   restart: always
  #   ports:
  #     - "8661:80"
  #   deploy:
  #     mode: replicated
  #     replicas: 1
